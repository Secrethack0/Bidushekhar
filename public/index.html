<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Speech to Gemini AI</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #222;
        color: #eee;
      }
      .container {
        width: 90vw;
        max-width: 600px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      textarea {
        width: 100%;
        height: 100px;
        font-size: 1.2rem;
        padding: 0.5rem;
        border-radius: 8px;
        border: none;
        resize: vertical;
      }
      button {
        font-size: 1.2rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        background: #4caf50;
        color: white;
        border: none;
      }
      #resultOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #111;
        color: #0f0;
        font-size: 2.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
        white-space: pre-wrap;
        padding: 2rem;
        box-sizing: border-box;
        overflow-y: auto;
        z-index: 10;
        display: none;
      }
      #typewriterCursor {
        display: inline-block;
        width: 10px;
        background-color: #0f0;
        margin-left: 2px;
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        50.01%,
        100% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <textarea
        id="inputText"
        placeholder="Type or speak your question here..."
      ></textarea>
      <button id="micButton">ðŸŽ¤ Start Speaking</button>
    </div>

    <div
      id="resultOverlay"
      aria-live="polite"
      role="alert"
      aria-atomic="true"
    ></div>

    <script>
      const inputText = document.getElementById("inputText");
      const micButton = document.getElementById("micButton");
      const resultOverlay = document.getElementById("resultOverlay");

      let recognizing = false;
      let recognition;

      // Speech Recognition Setup
      if (
        "webkitSpeechRecognition" in window ||
        "SpeechRecognition" in window
      ) {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = "en-US";

        recognition.onresult = async (event) => {
          let interimTranscript = "";
          let finalTranscript = inputText.value;

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript + " ";
            } else {
              interimTranscript += transcript;
            }
          }
          inputText.value = finalTranscript + interimTranscript;

          const prompt = inputText.value;
          console.log("Final prompt:", prompt);
          if (!prompt) return alert("Please enter or speak a question first.");
          micButton.disabled = true;
          inputText.disabled = true;

          const answer = await sendToGemini(prompt);
          inputText.value = "";
          await typeWriter(answer);
          speakText(answer);

          micButton.disabled = false;
          inputText.disabled = false;
        };

        recognition.onerror = (event) => {
          console.error("Speech recognition error", event.error);
          stopRecognition();
        };
      } else {
        micButton.disabled = true;
        micButton.title = "Speech recognition not supported in this browser.";
      }

      function startRecognition() {
        recognition.start();
        micButton.textContent = "ðŸ›‘ Stop Speaking";
        recognizing = true;
      }

      function stopRecognition() {
        recognition.stop();
        micButton.textContent = "ðŸŽ¤ Start Speaking";
        recognizing = false;
      }

      micButton.addEventListener("click", () => {
        if (!recognizing) {
          startRecognition();
        } else {
          stopRecognition();
        }
      });

      // Typewriter effect function
      async function typeWriter(text) {
        resultOverlay.textContent = "";
        resultOverlay.style.display = "flex";
        const cursor = document.createElement("span");
        cursor.id = "typewriterCursor";
        resultOverlay.appendChild(cursor);

        for (let i = 0; i < text.length; i++) {
          resultOverlay.textContent = text.substring(0, i + 1);
          resultOverlay.appendChild(cursor);
          await new Promise((r) => setTimeout(r, 40)); // 40ms per char
        }
      }

      function speakText(text) {
        const synth = window.speechSynthesis;
        if (!synth) return;
        const utter = new SpeechSynthesisUtterance(text);
        synth.speak(utter);
      }

      async function sendToGemini(text) {
        try {
          console.log(JSON.stringify({ prompt: text.trim() }));

          const response = await fetch(
            "https://bidushekhar.vercel.app/api/gemini",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ prompt: text.trim()})
            }
          );
          console.dir(response, { depth: null });
          if (!response.ok) throw new Error("Network response not ok");
          const data = await response.json();
          return data.answer || "No answer from API";
        } catch (err) {
          console.error("Error calling Gemini API:", err);
          return "Error calling AI service.";
        }
      }

      // Hide result on click to allow new queries
      resultOverlay.addEventListener("click", () => {
        resultOverlay.style.display = "none";
      });
    </script>
  </body>
</html>
